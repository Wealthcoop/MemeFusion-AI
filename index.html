<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    
    <!-- SEO & App Store Metadata -->
    <title>MemeFusion AI | Next-Gen Meme Studio</title>
    <meta name="theme-color" content="#020617">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="application-name" content="MemeFusion">
    <meta name="description" content="The ultimate AI meme forge. Features Vision Captioning, Cinematic Image Fusion, and AI Voice synthesis for viral content.">

    <!-- Web App Manifest (Data URI for Store Compliance) -->
    <link rel="manifest" href='data:application/manifest+json,{"name":"MemeFusion AI","short_name":"MemeFusion","start_url":".","display":"standalone","background_color":"#020617","theme_color":"#eab308","icons":[{"src":"https://cdn-icons-png.flaticon.com/512/2584/2584683.png","sizes":"512x512","type":"image/png"}]}'>

    <!-- Social Graphs -->
    <meta property="og:type" content="website">
    <meta property="og:title" content="MemeFusion AI Studio">
    <meta property="og:description" content="Synthesize viral content with Gemini 2.5 AI. High-fidelity memes in seconds.">
    
    <!-- Dependencies -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700;900&display=swap');
        
        :root {
            --brand-yellow: #eab308;
            --bg-slate: #020617;
        }

        body { 
            font-family: 'Inter', sans-serif; 
            -webkit-tap-highlight-color: transparent; 
            scroll-behavior: smooth;
            background-color: var(--bg-slate);
            color: white;
            overflow-x: hidden;
            user-select: none;
        }

        .no-scrollbar::-webkit-scrollbar { display: none; }
        
        .bg-grid {
            background-image: radial-gradient(circle at 2px 2px, rgba(255,255,255,0.03) 1px, transparent 0);
            background-size: 32px 32px;
        }

        .glow-text {
            text-shadow: 0 0 30px rgba(234, 179, 8, 0.4);
        }

        @keyframes float {
            0% { transform: translateY(0px); }
            50% { transform: translateY(-12px); }
            100% { transform: translateY(0px); }
        }
        .animate-float { animation: float 6s ease-in-out infinite; }

        .glass-panel {
            background: rgba(15, 23, 42, 0.7);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.08);
        }

        input[type=range] { -webkit-appearance: none; background: transparent; }
        input[type=range]::-webkit-slider-runnable-track { width: 100%; height: 8px; background: #1e293b; border-radius: 4px; }
        input[type=range]::-webkit-slider-thumb { 
            -webkit-appearance: none; 
            height: 32px; width: 32px; 
            border-radius: 50%; 
            background: var(--brand-yellow); 
            cursor: pointer; 
            margin-top: -12px; 
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.6);
            border: 3px solid #020617;
        }

        .meme-text {
            text-shadow: 
                2px 2px 0px #000, 
                -2px -2px 0px #000, 
                2px -2px 0px #000, 
                -2px 2px 0px #000,
                0px 4px 15px rgba(0,0,0,0.8);
        }

        .safe-pb { padding-bottom: calc(env(safe-area-inset-bottom) + 1.5rem); }
        .safe-pt { padding-top: calc(env(safe-area-inset-top) + 1rem); }
    </style>
</head>
<body class="bg-grid">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useCallback } = React;

        const apiKey = "AIzaSyDtrWM-GYEYXfb2iNK0FThUcRg78Io_l";;

        // --- PRODUCTION CONSTANTS ---
        const COMMUNITY_FEED = [
            { id: 1, url: 'https://images.unsplash.com/photo-1514888286974-6c03e2ca1dba?w=400&h=400&fit=crop', top: 'When the code', bottom: 'Finally runs', filter: '3D Render' },
            { id: 2, url: 'https://images.unsplash.com/photo-1517841905240-472988babdf9?w=400&h=400&fit=crop', top: 'Waiting for', bottom: 'The weekend', filter: 'Cyberpunk' },
            { id: 3, url: 'https://images.unsplash.com/photo-1533738363-b7f9aef128ce?w=400&h=400&fit=crop', top: 'AI took my', bottom: 'Sandwich', filter: 'Anime' },
            { id: 4, url: 'https://images.unsplash.com/photo-1543852786-1cf6624b9987?w=400&h=400&fit=crop', top: 'Sigma Cat', bottom: 'Grindset', filter: 'Retro' },
        ];

        const STARTER_TEMPLATES = [
            { id: 'cat', name: 'Viral Cat', url: 'https://images.unsplash.com/photo-1514888286974-6c03e2ca1dba?w=400&h=400&fit=crop' },
            { id: 'office', name: 'The Office', url: 'https://images.unsplash.com/photo-1516733725897-1aa73b87c8e8?w=400&h=400&fit=crop' },
            { id: 'galaxy', name: 'Galaxy', url: 'https://images.unsplash.com/photo-1446776811953-b23d57bd21aa?w=400&h=400&fit=crop' },
            { id: 'neon', name: 'Retro Vibes', url: 'https://images.unsplash.com/photo-1618005182384-a83a8bd57fbe?w=400&h=400&fit=crop' },
        ];

        const PRESET_COLORS = [
            { name: 'White', value: '#ffffff' },
            { name: 'Yellow', value: '#eab308' },
            { name: 'Red', value: '#ef4444' },
            { name: 'Cyan', value: '#06b6d4' },
            { name: 'Green', value: '#22c55e' },
            { name: 'Pink', value: '#ec4899' },
        ];

        const LAYOUTS = [
            { id: 'classic', name: 'Classic', icon: 'layout-template' },
            { id: 'top', name: 'Header', icon: 'align-start-vertical' },
            { id: 'bottom', name: 'Footer', icon: 'align-end-vertical' },
            { id: 'center', name: 'Impact', icon: 'align-center' },
        ];

        const AI_FILTERS = [
            { id: 'none', name: 'Original', icon: 'image', prompt: '' },
            { id: 'cyberpunk', name: 'Cyberpunk', icon: 'zap', prompt: 'neon-drenched aesthetic, futuristic, night city' },
            { id: 'retro', name: 'Retro', icon: 'monitor', prompt: 'vintage 80s VHS, retrowave, scanlines' },
            { id: '3d', name: '3D Render', icon: 'box', prompt: 'high-end 3D render, Pixar lighting, octane render' },
            { id: 'anime', name: 'Anime', icon: 'swords', prompt: 'studio ghibli art style, cell shaded' },
            { id: 'oil', name: 'Oil Painting', icon: 'palette', prompt: 'classical oil painting textures, museum quality' },
        ];

        // --- UTILS ---

        const haptic = (type = 'medium') => {
            if (window.navigator.vibrate) {
                const patterns = { light: 10, medium: 20, heavy: 40 };
                window.navigator.vibrate(patterns[type] || patterns.medium);
            }
        };

        const fetchWithRetry = async (url, options, maxRetries = 5) => {
            for (let i = 0; i < maxRetries; i++) {
                try {
                    const response = await fetch(url, options);
                    if (response.ok) return await response.json();
                    if (response.status === 429) throw new Error("Rate limited");
                } catch (err) {
                    if (i === maxRetries - 1) throw err;
                    const delay = Math.pow(2, i) * 1000;
                    await new Promise(res => setTimeout(res, delay));
                }
            }
        };

        const Icon = ({ name, size = 24, className = "" }) => {
            const containerRef = useRef(null);
            useEffect(() => {
                if (window.lucide && containerRef.current) {
                    containerRef.current.innerHTML = `<i data-lucide="${name}" style="width: ${size}px; height: ${size}px;" class="${className}"></i>`;
                    window.lucide.createIcons({ root: containerRef.current });
                }
            }, [name, size, className]);
            return <span ref={containerRef} className="inline-flex items-center justify-center"></span>;
        };

        function pcmToWav(pcmData, sampleRate) {
            const buffer = new ArrayBuffer(44 + pcmData.length);
            const view = new DataView(buffer);
            const writeString = (offset, string) => {
                for (let i = 0; i < string.length; i++) view.setUint8(offset + i, string.charCodeAt(i));
            };
            writeString(0, 'RIFF');
            view.setUint32(4, 36 + pcmData.length, true);
            writeString(8, 'WAVE');
            writeString(12, 'fmt ');
            view.setUint32(16, 16, true);
            view.setUint16(20, 1, true);
            view.setUint16(22, 1, true);
            view.setUint32(24, sampleRate, true);
            view.setUint32(28, sampleRate * 2, true);
            view.setUint16(32, 2, true);
            view.setUint16(34, 16, true);
            writeString(36, 'data');
            view.setUint32(40, pcmData.length, true);
            new Uint8Array(buffer, 44).set(new Uint8Array(pcmData));
            return new Blob([buffer], { type: 'audio/wav' });
        }

        // --- MODALS ---

        function Modal({ isOpen, onClose, title, children }) {
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 z-[200] flex items-end sm:items-center justify-center p-4">
                    <div className="absolute inset-0 bg-black/90 backdrop-blur-md" onClick={onClose}></div>
                    <div className="relative glass-panel w-full max-w-lg rounded-[3rem] p-8 space-y-6 animate-float shadow-2xl">
                        <div className="flex justify-between items-center border-b border-white/5 pb-4">
                            <h2 className="text-xl font-black uppercase italic tracking-tighter">{title}</h2>
                            <button onClick={onClose} className="p-3 bg-white/5 rounded-full"><Icon name="x" size={20}/></button>
                        </div>
                        <div className="max-h-[60vh] overflow-y-auto no-scrollbar pr-2 space-y-4 text-sm text-slate-400 font-medium">
                            {children}
                        </div>
                    </div>
                </div>
            );
        }

        function App() {
            const [view, setView] = useState('landing');
            const [activeModal, setActiveModal] = useState(null); // 'settings', 'privacy', 'terms'
            const [image, setImage] = useState(null);
            const [topText, setTopText] = useState("");
            const [bottomText, setBottomText] = useState("");
            const [fontSize, setFontSize] = useState(36);
            const [textColor, setTextColor] = useState('#ffffff');
            const [layout, setLayout] = useState('classic');
            const [selectedFilter, setSelectedFilter] = useState('none');
            const [loading, setLoading] = useState(false);
            const [visionLoading, setVisionLoading] = useState(false);
            const [voiceLoading, setVoiceLoading] = useState(false);
            const [fusedImage, setFusedImage] = useState(null);
            const [history, setHistory] = useState([]);
            const [error, setError] = useState(null);
            const [isOnline, setIsOnline] = useState(window.navigator.onLine);

            // Back Button Persistence
            useEffect(() => {
                const handleBackButton = (e) => {
                    if (view === 'editor') {
                        e.preventDefault();
                        setView('landing');
                        window.history.pushState(null, '', window.location.href);
                    }
                };
                window.history.pushState(null, '', window.location.href);
                window.addEventListener('popstate', handleBackButton);
                const handleOnline = () => setIsOnline(true);
                const handleOffline = () => setIsOnline(false);
                window.addEventListener('online', handleOnline);
                window.addEventListener('offline', handleOffline);
                return () => {
                    window.removeEventListener('popstate', handleBackButton);
                    window.removeEventListener('online', handleOnline);
                    window.removeEventListener('offline', handleOffline);
                };
            }, [view]);

            const handleFileUpload = (e) => {
                const file = e.target.files[0];
                if (file) {
                    haptic('light');
                    const reader = new FileReader();
                    reader.onload = (ev) => { setImage(ev.target.result); setFusedImage(null); };
                    reader.readAsDataURL(file);
                }
            };

            const suggestCaptions = async () => {
                if (!image || visionLoading || !isOnline) return;
                haptic('light');
                setVisionLoading(true);
                setError(null);
                const base64Data = image.split(',')[1];
                try {
                    const res = await fetchWithRetry(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            contents: [{ parts: [{ text: "Suggest a hilarious, short meme caption for this image. Output JSON only: {top: string, bottom: string}." }, { inlineData: { mimeType: "image/png", data: base64Data } }] }],
                            generationConfig: { responseMimeType: "application/json" }
                        })
                    });
                    const suggested = JSON.parse(res.candidates[0].content.parts[0].text);
                    setTopText(suggested.top.toUpperCase());
                    setBottomText(suggested.bottom.toUpperCase());
                    haptic('medium');
                } catch (e) { setError("AI Vision failed. Check your network."); } finally { setVisionLoading(false); }
            };

            const fuseWithAI = async () => {
                if (!image || !isOnline) return;
                haptic('medium');
                setLoading(true);
                setError(null);
                const filter = AI_FILTERS.find(f => f.id === selectedFilter);
                const base64Data = image.split(',')[1];
                try {
                    const res = await fetchWithRetry(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-image-preview:generateContent?key=${apiKey}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            contents: [{ parts: [{ text: `Re-imagine meme: "${topText} ${bottomText}". Aesthetic: ${filter.prompt}. Studio quality.` }, { inlineData: { mimeType: "image/png", data: base64Data } }] }],
                            generationConfig: { responseModalities: ['TEXT', 'IMAGE'] }
                        })
                    });
                    const b64 = res.candidates[0].content.parts.find(p => p.inlineData).inlineData.data;
                    const newUrl = `data:image/png;base64,${b64}`;
                    setFusedImage(newUrl);
                    setHistory(prev => [{ id: Date.now(), url: newUrl, top: topText, bottom: bottomText }, ...prev].slice(0, 5));
                    haptic('heavy');
                } catch (e) { setError("Fusion logic error. Try another aesthetic."); } finally { setLoading(false); }
            };

            const speakMeme = async () => {
                if (!topText && !bottomText || !isOnline) return;
                haptic('light');
                setVoiceLoading(true);
                try {
                    const res = await fetchWithRetry(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-tts:generateContent?key=${apiKey}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            contents: [{ parts: [{ text: `Read with extreme viral meme energy: ${topText}. ${bottomText}` }] }],
                            generationConfig: { responseModalities: ["AUDIO"], speechConfig: { voiceConfig: { prebuiltVoiceConfig: { voiceName: "Puck" } } } }
                        })
                    });
                    const audioPart = res.candidates[0].content.parts[0].inlineData;
                    const rate = parseInt(audioPart.mimeType.split('rate=')[1]) || 24000;
                    const pcm = new Uint8Array(atob(audioPart.data).split("").map(c => c.charCodeAt(0)));
                    new Audio(URL.createObjectURL(pcmToWav(pcm, rate))).play();
                } catch (e) { setError("TTS Narrator failed."); } finally { setVoiceLoading(false); }
            };

            const handleShare = async () => {
                haptic('light');
                const target = fusedImage || image;
                if (!target) return;
                if (navigator.share) {
                    try {
                        const res = await fetch(target);
                        const blob = await res.blob();
                        const file = new File([blob], 'memefusion.png', { type: 'image/png' });
                        await navigator.share({ files: [file], title: 'MemeFusion AI' });
                    } catch (e) {}
                } else {
                    const l=document.createElement('a'); l.href=target; l.download='meme.png'; l.click();
                }
            };

            if (view === 'landing') {
                return (
                    <div className="min-h-screen flex flex-col items-center">
                        <nav className="w-full p-6 flex justify-between items-center max-w-6xl z-10 safe-pt">
                            <div className="flex items-center gap-2">
                                <Icon name="sparkles" size={24} className="text-yellow-500" />
                                <span className="text-xl font-black uppercase tracking-tighter italic">MemeFusion</span>
                            </div>
                            <div className="flex gap-2">
                                <button onClick={() => setActiveModal('settings')} className="p-3 glass-panel rounded-full active:scale-90 transition-transform">
                                    <Icon name="settings" size={20} />
                                </button>
                                <button onClick={() => setView('editor')} className="bg-yellow-500 text-slate-950 px-6 py-2 rounded-full text-xs font-black uppercase shadow-lg active:scale-95">
                                    Forge
                                </button>
                            </div>
                        </nav>

                        <main className="flex-1 flex flex-col items-center justify-center text-center px-6 py-12 max-w-5xl z-10">
                            <div className="inline-flex items-center gap-2 px-4 py-2 rounded-full bg-yellow-500/10 border border-yellow-500/20 text-yellow-500 text-[10px] font-black uppercase tracking-[0.2em] mb-10">
                                <Icon name="zap" size={12} /> Google Play Certified
                            </div>
                            <h1 className="text-6xl md:text-9xl font-black italic uppercase tracking-tighter mb-8 leading-[0.8] glow-text">Next-Gen <br/> <span className="text-yellow-500">Meme Forge</span></h1>
                            <p className="text-slate-400 text-lg md:text-2xl max-w-2xl mb-12 font-medium">Create, Fuse, and Narrate with AI. Synthesis Pro v2.5.0</p>
                            <button onClick={() => { haptic('medium'); setView('editor'); }} className="px-12 py-6 bg-yellow-500 text-slate-950 rounded-full font-black uppercase italic tracking-tighter text-2xl hover:scale-105 active:scale-95 transition-all shadow-[0_0_50px_rgba(234,179,8,0.4)] mb-20">Enter Forge</button>
                            
                            <div className="grid grid-cols-1 md:grid-cols-3 gap-6 w-full mb-32">
                                <div className="p-8 glass-panel rounded-[2.5rem] text-left">
                                    <Icon name="wand-2" className="text-yellow-500 mb-4" />
                                    <h4 className="font-black uppercase italic mb-1">Meme Vision</h4>
                                    <p className="text-slate-500 text-sm">AI context-aware captions.</p>
                                </div>
                                <div className="p-8 glass-panel rounded-[2.5rem] text-left">
                                    <Icon name="zap" className="text-yellow-500 mb-4" />
                                    <h4 className="font-black uppercase italic mb-1">Fusion Pro</h4>
                                    <p className="text-slate-500 text-sm">Cinematic diffusion engine.</p>
                                </div>
                                <div className="p-8 glass-panel rounded-[2.5rem] text-left">
                                    <Icon name="volume-2" className="text-yellow-500 mb-4" />
                                    <h4 className="font-black uppercase italic mb-1">Narrator</h4>
                                    <p className="text-slate-500 text-sm">High-energy viral synthesis.</p>
                                </div>
                            </div>

                            <div className="w-full space-y-8">
                                <div className="flex items-center justify-between border-b border-white/5 pb-4 px-2">
                                    <h2 className="text-xs font-black uppercase tracking-[0.2em] text-slate-500">Trending Now</h2>
                                    <div className="flex items-center gap-2 text-yellow-500 text-[10px] font-bold"><Icon name="globe" size={12} /> LIVE TRENDS</div>
                                </div>
                                <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                                    {COMMUNITY_FEED.map(meme => (
                                        <div key={meme.id} className="group relative aspect-square rounded-[2rem] overflow-hidden border border-white/10 bg-slate-900 shadow-2xl">
                                            <img src={meme.url} className="w-full h-full object-cover grayscale opacity-40 transition-all duration-700 group-hover:grayscale-0 group-hover:opacity-100" />
                                        </div>
                                    ))}
                                </div>
                            </div>
                        </main>

                        <footer className="w-full py-12 text-center text-slate-700 border-t border-white/5 safe-pb">
                            <div className="flex justify-center gap-6 mb-6">
                                <button onClick={() => setActiveModal('privacy')} className="text-[10px] font-black uppercase hover:text-white transition-colors">Privacy</button>
                                <button onClick={() => setActiveModal('terms')} className="text-[10px] font-black uppercase hover:text-white transition-colors">Terms</button>
                            </div>
                            <p className="text-[10px] font-black uppercase tracking-widest">© 2025 MemeFusion AI Studio • Build Ready</p>
                        </footer>

                        {!isOnline && <div className="fixed top-0 inset-x-0 bg-red-500 text-white text-[10px] font-black py-1 text-center z-[300]">OFFLINE MODE - AI SYNC PAUSED</div>}
                        
                        {/* Legal Modals */}
                        <Modal isOpen={activeModal === 'settings'} onClose={() => setActiveModal(null)} title="Forge Settings">
                            <div className="space-y-4">
                                <div className="p-4 bg-white/5 rounded-2xl border border-white/5">
                                    <h4 className="text-xs font-black uppercase text-yellow-500 mb-1">Developer Support</h4>
                                    <p className="text-sm text-white font-medium">support@memefusion.ai</p>
                                </div>
                                <div className="p-4 bg-white/5 rounded-2xl border border-white/5">
                                    <h4 className="text-xs font-black uppercase text-yellow-500 mb-1">Version Info</h4>
                                    <p className="text-sm text-white font-medium">Build v2.5.0 Stable</p>
                                </div>
                                <button className="w-full py-4 bg-red-500/10 text-red-500 rounded-2xl font-bold text-sm border border-red-500/10 active:scale-95" onClick={() => location.reload()}>Clear App State</button>
                            </div>
                        </Modal>

                        <Modal isOpen={activeModal === 'privacy'} onClose={() => setActiveModal(null)} title="Privacy Policy">
                            <p>MemeFusion AI uses on-demand transient processing. Your original uploads are processed in volatile memory and purged upon session termination.</p>
                            <p>Final generated fusions may be featured anonymously in our public showcase to foster community creativity.</p>
                        </Modal>

                        <Modal isOpen={activeModal === 'terms'} onClose={() => setActiveModal(null)} title="Terms of Service">
                            <p>Users are responsible for the content they generate. Prohibited content includes hate speech, harassment, or non-consensual imagery.</p>
                            <p>By using this tool, you grant MemeFusion a non-exclusive license to display generated content in our community feeds.</p>
                        </Modal>
                    </div>
                );
            }

            return (
                <div key="editor" className="min-h-screen bg-slate-900 text-white flex flex-col selection:bg-yellow-500 selection:text-slate-950">
                    <header className="p-6 pt-12 flex justify-between items-center bg-slate-900/50 backdrop-blur-xl border-b border-white/5 sticky top-0 z-40 safe-pt">
                        <button onClick={() => { haptic('light'); setView('landing'); }} className="flex items-center gap-2 group">
                            <Icon name="chevron-left" size={20} className="text-slate-500 group-hover:text-white" />
                            <Icon name="sparkles" size={20} className="text-yellow-500" />
                            <h1 className="text-xl font-black italic uppercase tracking-tighter">Forge</h1>
                        </button>
                        <div className="bg-yellow-500 text-slate-950 px-4 py-1 rounded-full text-[10px] font-black shadow-lg">PRO ACTIVE</div>
                    </header>

                    <main className="flex-1 p-6 space-y-8 max-w-2xl mx-auto w-full pb-32 overflow-y-auto no-scrollbar">
                        {error && (
                            <div className="bg-red-500/10 border border-red-500/50 p-4 rounded-3xl text-red-500 text-xs font-bold text-center flex items-center justify-center gap-2 animate-pulse">
                                <Icon name="alert-circle" size={14} /> {error}
                            </div>
                        )}

                        <div className="aspect-square bg-slate-800 rounded-[3rem] border border-white/5 flex flex-col items-center justify-center relative overflow-hidden shadow-2xl active:scale-[0.98] transition-transform">
                            {loading && (
                                <div className="absolute inset-0 z-30 bg-slate-950/90 flex flex-col items-center justify-center space-y-4">
                                    <div className="w-16 h-16 border-4 border-yellow-500 border-t-transparent rounded-full animate-spin"></div>
                                    <p className="font-black uppercase tracking-widest text-[10px] text-yellow-500">AI Synthesizing...</p>
                                </div>
                            )}

                            {!image ? (
                                <div className="text-center space-y-4">
                                    <div className="w-20 h-20 bg-slate-700/50 rounded-full flex items-center justify-center mx-auto border border-white/10 group-hover:scale-110 transition-transform"><Icon name="upload" className="text-slate-500" /></div>
                                    <p className="text-[10px] font-black uppercase tracking-widest text-slate-500">Upload Base Image</p>
                                </div>
                            ) : (
                                <div className="w-full h-full relative">
                                    <img src={fusedImage || image} className="w-full h-full object-cover" alt="Forge Output" />
                                    {!fusedImage && (
                                        <div className={`absolute inset-0 p-8 flex flex-col pointer-events-none ${layout === 'classic' ? 'justify-between' : layout === 'top' ? 'justify-start' : layout === 'bottom' ? 'justify-end' : 'justify-center'}`}>
                                            <h2 className="text-center font-black uppercase break-words leading-none meme-text" style={{ fontSize: `${fontSize}px`, color: textColor }}>{topText}</h2>
                                            {(layout === 'classic' || layout === 'bottom') && <h2 className="text-center font-black uppercase break-words leading-none meme-text" style={{ fontSize: `${fontSize}px`, color: textColor }}>{bottomText}</h2>}
                                        </div>
                                    )}
                                </div>
                            )}
                            {!loading && <input type="file" accept="image/*" className="absolute inset-0 opacity-0 cursor-pointer" onChange={handleFileUpload} />}
                        </div>

                        {!image && (
                            <div className="flex gap-4 overflow-x-auto no-scrollbar py-2">
                                {STARTER_TEMPLATES.map(t => (
                                    <button key={t.id} onClick={() => { haptic('light'); setImage(t.url); }} className="flex-shrink-0 w-24 h-24 rounded-[1.5rem] overflow-hidden border border-white/10 active:scale-90 transition-transform shadow-xl"><img src={t.url} className="w-full h-full object-cover" /></button>
                                ))}
                            </div>
                        )}

                        <div className="space-y-6">
                            <div className="bg-slate-800/30 p-2 rounded-[2rem] border border-white/5 flex gap-1 shadow-lg">
                                {LAYOUTS.map(L => (
                                    <button key={L.id} onClick={() => { haptic('light'); setLayout(L.id); }} className={`flex-1 py-4 rounded-3xl flex flex-col items-center gap-1 transition-all ${layout === L.id ? 'bg-yellow-500 text-slate-950 font-black' : 'text-slate-500 opacity-60'}`}>
                                        <Icon name={L.icon} size={18} /><span className="text-[9px] uppercase font-bold tracking-tighter">{L.name}</span>
                                    </button>
                                ))}
                            </div>

                            <div className="space-y-4 relative">
                                <button onClick={suggestCaptions} disabled={visionLoading || !image || !isOnline} className={`absolute -top-12 right-0 flex items-center gap-2 px-4 py-2 rounded-full text-[10px] font-black uppercase transition-all shadow-xl ${visionLoading ? 'bg-slate-800 text-slate-600' : 'bg-indigo-600 text-white active:scale-95'}`}>
                                    {visionLoading ? <div className="w-3 h-3 border-2 border-white/30 border-t-white rounded-full animate-spin"></div> : <Icon name="wand-2" size={14} />}AI Vision
                                </button>
                                <div className="bg-slate-800/50 p-5 rounded-[2rem] border border-white/5 shadow-inner">
                                    <input placeholder={layout === 'center' ? "MAIN MESSAGE" : "TOP TEXT"} className="bg-transparent w-full text-center font-black uppercase outline-none placeholder:text-slate-700 text-xl" value={topText} onChange={e => setTopText(e.target.value)} />
                                </div>
                                {(layout === 'classic' || layout === 'bottom') && (
                                    <div className="bg-slate-800/50 p-5 rounded-[2rem] border border-white/5 shadow-inner">
                                        <input placeholder="BOTTOM TEXT" className="bg-transparent w-full text-center font-black uppercase outline-none placeholder:text-slate-700 text-xl" value={bottomText} onChange={e => setBottomText(e.target.value)} />
                                    </div>
                                )}
                            </div>

                            <div className="flex gap-3 overflow-x-auto no-scrollbar pb-2 px-1">
                                {AI_FILTERS.map(F => (
                                    <button key={F.id} onClick={() => { haptic('light'); setSelectedFilter(F.id); }} className={`flex-shrink-0 px-6 py-4 rounded-[1.5rem] border transition-all flex items-center gap-3 shadow-md ${selectedFilter === F.id ? 'bg-yellow-500/20 border-yellow-500 text-yellow-500 shadow-yellow-500/10' : 'bg-slate-800/30 border-white/5 text-slate-400'}`}>
                                        <Icon name={F.icon} size={16} /><span className="text-[11px] font-black uppercase tracking-widest">{F.name}</span>
                                    </button>
                                ))}
                            </div>

                            <div className="bg-slate-800/30 p-8 rounded-[2.5rem] border border-white/5 space-y-6 shadow-lg">
                                <div className="flex justify-between items-center"><label className="text-xs font-black text-slate-500 uppercase tracking-[0.2em]">Font Scale</label><span className="text-[10px] font-black text-yellow-500">{fontSize}PX</span></div>
                                <input type="range" min="12" max="100" value={fontSize} onChange={e => setFontSize(parseInt(e.target.value))} className="w-full" />
                                <div className="flex gap-3 overflow-x-auto no-scrollbar pb-2">
                                    {PRESET_COLORS.map(c => <button key={c.value} onClick={() => { haptic('light'); setTextColor(c.value); }} className={`w-10 h-10 rounded-full border-2 transition-transform active:scale-90 ${textColor === c.value ? 'border-yellow-500 scale-110' : 'border-transparent opacity-60'}`} style={{ backgroundColor: c.value }} />)}
                                </div>
                            </div>
                        </div>

                        <div className="grid grid-cols-1 gap-4 pt-6 safe-pb">
                            <button onClick={fuseWithAI} disabled={loading || !image || !isOnline} className={`w-full h-24 rounded-[2.5rem] font-black uppercase tracking-tighter transition-all shadow-2xl flex flex-col items-center justify-center gap-1 ${loading || !image || !isOnline ? 'bg-slate-800 text-slate-500' : 'bg-yellow-500 text-slate-950 active:scale-95'}`}>
                                <div className="flex items-center gap-2"><Icon name="zap" size={24} /><span className="text-2xl italic uppercase tracking-tighter">Fuse with AI</span></div>
                                <span className="text-[10px] font-black opacity-70 tracking-widest uppercase">Engine v2.5.0 Live</span>
                            </button>
                            <div className="grid grid-cols-3 gap-4">
                                <button onClick={speakMeme} disabled={voiceLoading || !isOnline} className="h-16 rounded-3xl glass-panel flex items-center justify-center active:scale-95 transition-all shadow-xl disabled:opacity-30">
                                    {voiceLoading ? <div className="w-5 h-5 border-2 border-white/30 border-t-white rounded-full animate-spin"></div> : <Icon name="volume-2" size={24} />}
                                </button>
                                <button onClick={() => { haptic('light'); const l=document.createElement('a'); l.href=fusedImage||image; l.download='meme.png'; l.click();}} className="h-16 rounded-3xl glass-panel flex items-center justify-center active:scale-95 transition-all shadow-xl"><Icon name="download" size={24} /></button>
                                <button onClick={handleShare} className="h-16 rounded-3xl glass-panel flex items-center justify-center active:scale-95 transition-all shadow-xl"><Icon name="share-2" size={24} /></button>
                            </div>
                        </div>

                        {history.length > 0 && (
                            <div className="space-y-6 pt-10 pb-10">
                                <h3 className="text-[10px] font-black uppercase tracking-widest text-slate-600 px-4 italic">History Logs</h3>
                                <div className="flex gap-4 overflow-x-auto pb-8 no-scrollbar px-2">
                                    {history.map(item => (
                                        <div key={item.id} className="w-32 flex-shrink-0 space-y-2 group cursor-pointer" onClick={() => { haptic('light'); setFusedImage(item.url); setTopText(item.top); setBottomText(item.bottom); }}>
                                            <div className="aspect-square rounded-[1.5rem] overflow-hidden border border-white/10 relative shadow-2xl group-active:scale-95 transition-transform"><img src={item.url} className="w-full h-full object-cover" /></div>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        )}
                    </main>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);

        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                const swCode = `self.addEventListener('fetch', function(e) { e.respondWith(fetch(e.request)); });`;
                const blob = new Blob([swCode], { type: 'text/javascript' });
                // navigator.serviceWorker.register(URL.createObjectURL(blob));
            });
        }
    </script>
</body>
</html>
